<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <title>Barrilete</title>
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha/css/bootstrap.css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet">
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twbs-pagination/1.3.1/jquery.twbsPagination.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twbs-pagination/1.3.1/jquery.twbsPagination.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/1000hz-bootstrap-validator/0.11.5/validator.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>       
    </head>
    <body>
        <section class="container">
            <br>
            <div class="row">
                <div class="col-lg-12 margin-tb">					
                    <div class="pull-left">
                        <h2>Consumiendo API RESTful</h2>
                    </div>
                    <div class="pull-right">
                        <button type="button" class="btn btn-success" data-toggle="modal" data-target="#create-item">Agregar Usuario</button>
                    </div>
                </div>
            </div>
            <table class="table table-hover">
                <thead class="bg-info">
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">Nombre</th>
                    <th scope="col">Apellido</th>
                    <th scope="col">Email</th>
                    <th scope="col">Teléfono</th>
                    <th scope="col">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <ul id="pagination" class="pagination"></ul>  
            
            <!-- CREAR USUARIO MODAL -->
            <div class="modal fade" id="create-item" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                        <h4 class="modal-title" id="myModalLabel">Agregar usuario</h4>
                    </div>
                    <div class="modal-body">
                        <form data-toggle="validator" method="POST" action="http://localhost/test/public/api/usuarios/crear">
                            <div class="form-group">
                                <label class="control-label" for="nombre">Nombre:</label>
                                <input type="text" name="nombre" class="form-control" data-error="Ingrese un nombre." value="" required />
                                <div class="help-block with-errors"></div>
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="apellido">Apellido:</label>
                                <input type="text" name="apellido" class="form-control" data-error="Ingrese un apellido." value="" required />
                                <div class="help-block with-errors"></div>
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="password">Contraseña:</label>
                                <input type="password" name="password" class="form-control" data-error="Ingrese una contraseña." value="" required />
                                <div class="help-block with-errors"></div>
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="email">E-mail:</label>
                                <input type="text" name="email" class="form-control" data-error="Ingrese un e-mail." value="" required />
                                <div class="help-block with-errors"></div>
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="telefono">Teléfono:</label>
                                <input type="text" name="telefono" class="form-control" data-error="Ingrese un teléfono." value="" required />
                                <div class="help-block with-errors"></div>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn crud-submit btn-success">Registrar</button>
                                <button type="reset" class="btn crud-reset .btn-default">Restablecer</button>
                            </div>
                        </form>
                    </div>
                </div>
              </div>
            </div>
            
            <!-- EDITAR USUARIO MODAL -->
            <div class="modal fade" id="edit-item" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                            <h4 class="modal-title" id="myModalLabel">Editar Usuario</h4>
                        </div>
                        <div class="modal-body">
                            <form data-toggle="validator" method="put">
                                <div class="form-group">
                                    <label class="control-label" for="nombre">Nombre:</label>
                                    <input type="text" name="nombre" class="form-control" data-error="Ingrese un nombre." required />
                                    <div class="help-block with-errors"></div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="apellido">Apellido:</label>
                                    <input type="text" name="apellido" class="form-control" data-error="Ingrese un apellido." required />
                                    <div class="help-block with-errors"></div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="email">E-mail:</label>
                                    <input type="text" name="email" class="form-control" data-error="Ingrese un e.mail." required />
                                    <div class="help-block with-errors"></div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="telefono">Teléfono:</label>
                                    <input type="text" name="telefono" class="form-control" data-error="Ingrese un teléfono." required />
                                    <div class="help-block with-errors"></div>
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-success crud-submit-edit">Actualizar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>           
        </section>
        <footer>            
        </footer>
        <script type="text/javascript"> 
            var page = 1;
            var current_page = 1;
            var total_page = 0;
            var is_ajax_fire = 0;
            var url = "http://localhost/test/public/api/usuarios";
            manageData();

            function manageData() {
                $.ajax({
                    dataType: 'json',
                    url: url,
                    data: {page:page}
                }).done(function(data){
                    total_page = data.last_page;
                    current_page = data.current_page;
                    $('#pagination').twbsPagination({
                        totalPages: total_page,
                        visiblePages: current_page,
                        onPageClick: function (event, pageL) {
                            page = pageL;
                            if(is_ajax_fire != 0){
                                      getPageData();
                            }
                        }
                    });
                    manageRow(data.data);
                    is_ajax_fire = 1;                   
                });
            }
            $.ajaxSetup({
                headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                    }
            });

            /* TRAER DATOS DE LA API */
            function getPageData() {
                    $.ajax({
                        dataType: 'json',
                        url: url,
                        data: {page:page}
                    }).done(function(data){
                        manageRow(data.data);
                    });
            }

            /* VER ELEMENTOS EN LA TABLA */
            function manageRow(data) {
                    var	rows = '';
                    $.each( data, function( key, value ) {
                            rows = rows + '<tr>';
                            rows = rows + '<td>'+value.id+'</td>';
                            rows = rows + '<td>'+value.nombre+'</td>';
                            rows = rows + '<td>'+value.apellido+'</td>';
                            rows = rows + '<td>'+value.email+'</td>';
                            rows = rows + '<td>'+value.telefono+'</td>';
                            rows = rows + '<td data-id="'+value.id+'">';
                            rows = rows + '<button data-toggle="modal" data-target="#edit-item" class="btn btn-primary edit-item">Editar</button> ';
                            rows = rows + '<button class="btn btn-danger remove-item">Eliminar</button>';
                            rows = rows + '</td>';
                            rows = rows + '</tr>';
                    });
                    $("tbody").html(rows);
            }

            /* CREAR NUEVO USUARIO */
            $(".crud-submit").click(function(e){
                e.preventDefault();    
                
                var form_action = $("#create-item").find("form").attr("action");
                var nombre = $("#create-item").find("input[name='nombre']").val();
                var apellido = $("#create-item").find("input[name='apellido']").val();
                var password = $("#create-item").find("input[name='password']").val();
                var email = $("#create-item").find("input[name='email']").val();
                var telefono = $("#create-item").find("input[name='telefono']").val();

                $.ajax({
                    dataType: 'json',
                    type:'post',                    
                    mode: 'cors',
                    header: {
                      'Access-Control-Allow-Origin': '*',
                      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS'
                    },
                    withCredentials: true,
                    credentials: 'same-origin',
                    url: form_action,
                    data:{nombre:nombre, apellido:apellido, password:password, email:email, telefono:telefono}
                }).done(function(data){
                    getPageData();
                    $(".modal").modal('hide');
                    toastr.success('Usuario creado con éxito.', 'Alerta de éxito', {timeOut: 5000});                   
                });
            });

            /* ELIMINAR USUARIO */
            $("body").on("click",".remove-item",function(){
                
                var id = $(this).parent("td").data('id');
                var c_obj = $(this).parents("tr");
                
                $.ajax({
                    dataType: 'json',
                    type:'delete',
                    url: url + '/' + id
                }).done(function(data){
                    c_obj.remove();
                    toastr.success('Usuario eliminado con éxito.', 'Alerta de éxito', {timeOut: 5000});
                    getPageData();
                });
            });

            /* EDITAR USUARIO */
            $("body").on("click",".edit-item",function(){
                
                var id = $(this).parent("td").data('id');
                var nombre = $(this).parent("td").prev("td").prev("td").prev("td").prev("td").text();
                var apellido = $(this).parent("td").prev("td").prev("td").prev("td").text();
                var email = $(this).parent("td").prev("td").prev("td").text();
                var telefono = $(this).parent("td").prev("td").text();
                
                $("#edit-item").find("input[name='nombre']").val(nombre);
                $("#edit-item").find("input[name='apellido']").val(apellido);
                $("#edit-item").find("input[name='email']").val(email);
                $("#edit-item").find("input[name='telefono']").val(telefono);
                $("#edit-item").find("form").attr("action",url + '/' + id);

            });

            /* ACTUALIZAR USUARIO */
            $(".crud-submit-edit").click(function(e){
                e.preventDefault();
                
                var form_action = $("#edit-item").find("form").attr("action");
                var nombre = $("#edit-item").find("input[name='nombre']").val();
                var apellido = $("#edit-item").find("input[name='apellido']").val();
                var email = $("#edit-item").find("input[name='email']").val();
                var telefono = $("#edit-item").find("input[name='telefono']").val();

                $.ajax({
                    dataType: 'json',
                    type:'PUT',
                    header: {
                      'Access-Control-Allow-Origin': '*',
                      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
                    },
                    url: form_action,
                    data:{nombre:nombre, apellido:apellido, email:email, telefono:telefono}
                }).done(function(data){
                    getPageData();
                    $(".modal").modal('hide');
                    toastr.success('Usuario actualizado correctamente.', 'Alerta de éxito', {timeOut: 5000});
                });
            });
        </script>
    </body>
</html>